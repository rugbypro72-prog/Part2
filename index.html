<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RJ & Alyvia</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
:root { --bg:#03050a; --me:#1e293b; --you:#0f172a; }
body { background:var(--bg); color:#f1f5f9; margin:0; height:100vh; overflow:hidden; }
#chat { max-width:600px; margin:auto; height:100%; display:flex; flex-direction:column; }
#messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; }
.bubble { max-width:85%; padding:12px 14px 28px; border-radius:20px; position:relative; }
.me { background:var(--me); align-self:flex-end; }
.you { background:var(--you); align-self:flex-start; }
.ts { position:absolute; bottom:6px; right:10px; font-size:9px; opacity:.5; }
.tools { display:flex; gap:8px; font-size:10px; margin-top:6px; opacity:.6; }
.tools span { cursor:pointer; }
.reactions { font-size:14px; margin-top:4px; display:flex; gap:6px; }
.pinned { border:2px solid #3b82f6; }
.reply { font-size:11px; opacity:.7; border-left:3px solid #3b82f6; padding-left:6px; margin-bottom:4px; }
</style>
</head>

<body>
<div id="chat">
<header class="p-4 border-b border-white/10 flex justify-between">
<strong>RJ & Alyvia</strong>
<input id="search" placeholder="Searchâ€¦" class="bg-black/40 px-3 py-1 rounded text-xs outline-none">
</header>

<div id="pinned" class="hidden p-2 border-b border-white/10 text-xs bg-black/30"></div>

<main id="messages"></main>

<footer class="p-4">
<form id="form" class="flex gap-2">
<input id="input" class="flex-1 bg-black/40 rounded-full px-4 py-3 outline-none" placeholder="Messageâ€¦">
<button class="bg-blue-600 px-6 rounded-full text-sm font-bold">Send</button>
</form>
</footer>
</div>

<script>
const SUPABASE_URL = "https://zsuvmrlgwjsjkzfbfljq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzdXZtcmxnd2pzamt6ZmJmbGpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDAwMTEsImV4cCI6MjA4Mzk3NjAxMX0.iBuU3DIfVx_dLGoWvZdwHMTA0bHgbd29Kxn2Dkec08A";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let me, you, messages = [], replyTo = null;

/* ---------- AUTH ---------- */
async function auth() {
  let code = localStorage.getItem("access_code");
  if (!code) {
    code = prompt("Access code:");
    localStorage.setItem("access_code", code);
  }

  const { data } = await db.from("chat_users").select("*").eq("access_code", code).single();
  if (!data) { localStorage.clear(); location.reload(); }

  me = data.username;
  you = me === "RJ" ? "Alyvia" : "RJ";
}
await auth();

/* ---------- REALTIME ---------- */
db.channel("chat")
  .on("postgres_changes", { event: "*", schema: "public", table: "private_messages" }, load)
  .on("postgres_changes", { event: "*", schema: "public", table: "message_reactions" }, load)
  .on("postgres_changes", { event: "*", schema: "public", table: "pinned_messages" }, load)
  .subscribe();

/* ---------- LOAD ---------- */
async function load() {
  const { data } = await db.from("private_messages")
    .select("*")
    .order("created_at");

  messages = data;
  render();
}

/* ---------- RENDER ---------- */
function render() {
  const q = document.getElementById("search").value.toLowerCase();
  const wrap = document.getElementById("messages");
  wrap.innerHTML = "";

  messages.filter(m => !q || m.message?.toLowerCase().includes(q))
    .forEach(m => {
      const div = document.createElement("div");
      div.className = `bubble ${m.sender === me ? "me" : "you"}`;

      if (m.reply_to) {
        const r = messages.find(x => x.id === m.reply_to);
        if (r) div.innerHTML += `<div class="reply">${r.message || "Message"}</div>`;
      }

      div.innerHTML += m.is_deleted ? "<i>Deleted</i>" : (m.message || "");

      div.innerHTML += `<div class="ts">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;

      if (m.sender === me && !m.is_deleted) {
        const t = document.createElement("div");
        t.className = "tools";
        t.innerHTML = `
          <span onclick="editMsg('${m.id}')">Edit</span>
          <span onclick="pinMsg('${m.id}')">Pin</span>
          <span onclick="deleteMsg('${m.id}')">Delete</span>
        `;
        div.appendChild(t);
      }

      const reacts = document.createElement("div");
      reacts.className = "reactions";
      ["â¤ï¸","ðŸ‘","ðŸ˜‚","ðŸ˜¡"].forEach(e=>{
        const s=document.createElement("span");
        s.textContent=e;
        s.onclick=()=>react(m.id,e);
        reacts.appendChild(s);
      });
      div.appendChild(reacts);

      wrap.appendChild(div);
    });

  wrap.scrollTop = wrap.scrollHeight;
}

/* ---------- ACTIONS ---------- */
async function send(text) {
  await db.from("private_messages").insert({ sender:me, receiver:you, message:text, reply_to:replyTo });
  replyTo=null;
}
async function deleteMsg(id) {
  await db.from("private_messages").update({ is_deleted:true }).eq("id",id);
}
async function editMsg(id) {
  const m = messages.find(x=>x.id===id);
  if (Date.now()-new Date(m.created_at).getTime()>5*60*1000) return alert("Edit window passed");
  const t = prompt("Edit message:", m.message);
  if (t) await db.from("private_messages").update({ message:t, edited_at:new Date() }).eq("id",id);
}
async function pinMsg(id) {
  await db.from("pinned_messages").upsert({ message_id:id, pinned_by:me });
}
async function react(id, r) {
  await db.from("message_reactions").upsert({ message_id:id, reactor:me, reaction:r });
}

/* ---------- FORM ---------- */
form.onsubmit = e => {
  e.preventDefault();
  if (input.value.trim()) send(input.value.trim());
  input.value="";
};
search.oninput = render;

load();
</script>
</body>
</html>
